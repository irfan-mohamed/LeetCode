-- -- Write your PostgreSQL query statement below
WITH join_tables AS (
    SELECT
        p.product_id,
        p.price,
        u.units,
        p.price*u.units AS total
    FROM
        Prices AS p
    LEFT JOIN
        UnitsSold AS u ON p.product_id = u.product_id AND u.purchase_date BETWEEN p.start_date AND p.end_date
)
SELECT
    jt.product_id,
    COALESCE(ROUND(SUM(jt.total)*1.0/SUM(jt.units),2),0) AS average_price
FROM
    join_tables AS jt
GROUP BY
    jt.product_id
;
